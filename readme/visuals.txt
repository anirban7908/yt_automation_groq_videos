File: visuals.py

1. What it does?
This file is the "Cinematographer" and "Location Scout" of your automation pipeline. Its job is to visualize the script. It reads the keywords generated by the Brain (e.g., "Cybersecurity", "Hacker"), searches for high-quality stock photos on professional platforms (Unsplash and Pexels), downloads them, and assigns them to the specific scenes in your video. It also includes "Quality Control" to ensure downloaded images are valid and not corrupted files.

2. What are the libraries used?
Here are the libraries imported in this file and why they are used:

* requests
  - Definition: The standard Python library for sending HTTP requests.
  - Why used here?: It is the core tool for talking to external APIs. It sends the search queries to Unsplash/Pexels (e.g., "GET /search?query=nature") and then downloads the actual binary image data from the URLs returned.

* PIL (Pillow)
  - Definition: The Python Imaging Library, the standard for image processing in Python.
  - Why used here?:
    1. Verification: It opens downloaded files to check if they are valid images (`img.verify()`). If a download is corrupted, Pillow detects it.
    2. Fallback: If no internet image is found, `Image.new()` creates a black placeholder image so the video editor (assembler) doesn't crash later.

* io
  - Definition: A module for handling byte streams (input/output).
  - Why used here?: It allows Pillow to open an image directly from the computer's memory (RAM) right after `requests` downloads it, without needing to save it to the hard drive first for verification.

* random
  - Definition: A module for making random selections.
  - Why used here?: When Unsplash returns 10 results for "Technology", we don't always want the #1 result (which is overused). `random.choice` picks one from the top list to keep your videos looking fresh and unique.

* core.db_manager.DBManager
  - Definition: Your custom class that handles database connections.
  - Why used here?: It fetches tasks with the status "voiced" (meaning audio is ready) and updates them to "ready_to_assemble" once images are downloaded.

* dotenv
  - Definition: A library to read configuration from `.env` files.
  - Why used here?: It securely loads your `UNSPLASH_ACCESS_KEY` and `PEXELS_API_KEY` so you don't have to hardcode passwords in the script.

* time
  - Definition: A module for time-related functions.
  - Why used here?: Used (`time.sleep`) to add a small delay between downloads. This prevents hitting API rate limits (getting banned for asking too fast).

* ollama
  - Definition: Library for local AI models.
  - Why used here?: Imported but **unused** in this specific file. It is likely a leftover import or intended for future features (like generating AI images if stock search fails).

3. Which is the main function and what does it do?

Main Function: download_visuals(self)

Description:
This is the director that manages the visual gathering process.
1. Fetching: It asks the database for a task where `status: "voiced"`.
2. Planning: It loops through every scene in the script and looks at the `image_count` (how many images this scene needs) and `keywords`.
3. Hunting: It calls the helper function `use_stock_search` to go find the images.
4. Fallback: If search fails, it generates a black "placeholder" image to ensure the file path exists.
5. Saving: It updates the database with the local paths of the downloaded images and changes status to "ready_to_assemble".

Helper Functions & Components Discussion:

* use_stock_search(self, query, path)
  - Purpose: The actual API handler.
  - How it works:
    1. It tries **Unsplash** first. It sends the keyword to the Unsplash API.
    2. If Unsplash finds nothing (or you have no key), it tries **Pexels** as a backup.
    3. If an image URL is found, it downloads the bytes.
    4. It passes those bytes to `is_valid_image`.
    5. If valid, it writes the file to your hard drive (`with open(path, "wb")`).

* is_valid_image(self, content)
  - Purpose: Quality Control.
  - How it works: It tries to open the downloaded bytes with Pillow. If the file is broken (e.g., a 404 error page saved as a .jpg), Pillow throws an error, and this function returns `False`. This prevents "corrupted file" errors during video assembly.